apiVersion: apps/v1
kind: Deployment
metadata:
  name: batch-predict            # Deployment name (used to manage this app)
  namespace: pm                  # Namespace where this app runs
spec:
  replicas: 1                    # Number of pod copies to run
  selector:
    matchLabels:
      app: batch-predict         # Must match the labels in the pod template
  template:
    metadata:
      labels:
        app: batch-predict       # Label used by the Service to find these pods
    spec:
      containers:
      - name: batch-predict      # Container name inside the pod
        image: docker.io/kaykit/pm-batch-predict:v1  # Docker image to run
        imagePullPolicy: IfNotPresent  # Always pull the image (useful during development)
        ports:
        - containerPort: 8002    # Port the app listens on inside the container
        envFrom:
        - configMapRef:
            name: pm-config      # Load environment variables from ConfigMap "pm-config"

        # Readiness probe: tells K8s when the app is ready to receive traffic
        readinessProbe:
          httpGet:
            path: /health        # Health endpoint your app must provide
            port: 8002
          initialDelaySeconds: 5 # Wait 5s after start before checking
          periodSeconds: 5       # Check every 5s

        # Liveness probe: tells K8s if the app is stuck/dead and should be restarted
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 15 # Wait longer before first liveness check
          periodSeconds: 10       # Check every 10s
---
apiVersion: v1
kind: Service
metadata:
  name: batch-predict            # Service name (stable DNS inside cluster)
  namespace: pm
spec:
  selector:
    app: batch-predict           # Sends traffic to pods with this label
  ports:
  - port: 8002                   # Service port inside the cluster
    targetPort: 8002             # Pod/container port to forward to
  type: ClusterIP                # Internal-only service (not exposed outside cluster)
