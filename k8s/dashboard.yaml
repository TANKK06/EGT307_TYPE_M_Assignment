apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard                  # Deployment name for the UI/dashboard component
  namespace: pm                    # Namespace this dashboard runs in
spec:
  replicas: 1                      # Run 1 copy of the dashboard pod
  selector:
    matchLabels:
      app: dashboard               # Must match the pod template labels
  template:
    metadata:
      labels:
        app: dashboard             # Label used by the Service to target these pods
    spec:
      containers:
      - name: dashboard            # Container name inside the pod
        image: docker.io/kaykit/pm-dashboard:v1   # Docker image for the dashboard (Streamlit)
        imagePullPolicy: IfNotPresent    # Always pull latest image for this tag (good for dev)
        ports:
        - containerPort: 8501      # Streamlit default port inside the container

        # Load non-sensitive environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: pm-config        # ConfigMap containing service URLs, etc.

        # Load sensitive environment variables from Secret
        env:
        - name: DATABASE_URL       # Environment variable name used by the dashboard app
          valueFrom:
            secretKeyRef:
              name: pm-secrets     # Secret name that stores DB connection string
              key: DATABASE_URL    # Key inside the Secret

        # Readiness probe: when successful, K8s will send traffic to this pod
        readinessProbe:
          httpGet:
            path: /_stcore/health  # Streamlit health endpoint
            port: 8501
          initialDelaySeconds: 10  # Wait 10s before first check
          periodSeconds: 10        # Check every 10s

        # Liveness probe: if this fails repeatedly, K8s restarts the container
        livenessProbe:
          httpGet:
            path: /_stcore/health
            port: 8501
          initialDelaySeconds: 30  # Wait longer before liveness checks
          periodSeconds: 20        # Check every 20s
---
apiVersion: v1
kind: Service
metadata:
  name: dashboard                  # Internal service name (DNS: dashboard.pm.svc.cluster.local)
  namespace: pm
spec:
  selector:
    app: dashboard                 # Routes traffic to pods labeled app=dashboard
  ports:
  - port: 8501                     # Service port inside the cluster
    targetPort: 8501               # Forward to container port 8501
  type: ClusterIP                  # Internal-only service (use Ingress/port-forward to access externally)
